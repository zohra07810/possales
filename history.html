<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#06812b">
<link rel="icon" href="baigsLogo.png" type="image/png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Receipt History</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { text-align: center; margin: 0; }

.table-container {
  overflow-x: auto;
  margin-top: 20px;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 650px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  text-align: center;
  font-size: 13px;
}

th {
  background-color: #f2f2f2;
}

button {
  padding: 4px 8px;
  margin: 2px;
  cursor: pointer;
  border-radius: 5px;
  border: none;
  font-size: 16px;
}

.view-btn { background-color: #06812b; color: white; }
.archive-btn { background-color: #ff4d4d; color: white; }
.back-btn {
  background-color: #555;
  color: white;
  margin-bottom: 15px;
  padding: 5px 15px;
}

/* MOBILE / RESPONSIVE */
@media (max-width: 480px) {
  th, td { font-size: 11px; }
  button { font-size: 12px; padding: 3px 6px; }
}

/* MODALS */
#viewModal, #archiveModal, #reportModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: #fff;
  padding: 15px;
  border-radius: 10px;
  width: 90%;
  max-width: 420px;
  max-height: 80%;
  overflow-y: auto;
}

.modal-header {
  font-weight: bold;
  text-align: center;
  margin-bottom: 10px;
}

.modal-buttons {
  text-align: center;
  margin-top: 10px;
}

.confirm-btn { background: #06812b; color: white; }
.cancel-btn { background: #555; color: white; }

/* HEADER */
.main-header {
  display: flex;
  flex-direction: column;
  background-color: #06812b;
  color: white;
  padding: 10px 15px;
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-left {
  display: flex;
  align-items: center;
  justify-content: space-between; /* logo left, hamburger right */
}

.header-left h1 {
  font-size: 18px;
  margin: 0;
}

/* HAMBURGER BUTTON */
.hamburger {
  font-size: 24px;
  background: none;
  border: none;
  color: white;
  cursor: pointer;
}

/* DROPDOWN MENU */
.mobile-menu {
  display: none;
  position: fixed;
  top: 60px;
  right: 15px;
  background: white;
  flex-direction: column;
  border-radius: 8px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.2);
  z-index: 9999;
}

.mobile-menu.show {
  display: flex;
}

/* Desktop: horizontal menu */
@media(min-width: 768px){
  .mobile-menu { 
    position: static;
    display: flex; 
    flex-direction: row; 
    margin-top:0; 
    background: none;
    box-shadow: none;
    width: auto;
  }
  .mobile-menu button { 
    margin: 0 5px; 
    border: none; 
    background: none;
    color: white;
  }
}

/* =====================
   GENERAL
===================== */
* {
  box-sizing: border-box;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
  padding: 0;
}

body {
  background: #f7f8fa;
}

/* =====================
   TABLE CONTAINER
===================== */
.table-container {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 20px;
  padding: 5px;
}

/* =====================
   TABLE
===================== */
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 500px;
}

th, td {
  padding: 10px;
  font-size: 14px;
  text-align: center;
  border-bottom: 1px solid #eee;
}

th {
  background: #f4f6f8;
  font-weight: 600;
}

tr:last-child td {
  border-bottom: none;
}

/* =====================
   BUTTONS
===================== */
button {
  border: none;
  border-radius: 6px;
  padding: 7px 12px;
  font-size: 13px;
  cursor: pointer;
  transition: 0.2s ease;
}

.view-btn {
  background: #2ecc71;
  color: white;
}

.view-btn:hover {
  background: #27ae60;
}

.delete-btn {
  background: #e74c3c;
  color: white;
}

.delete-btn:hover {
  background: #c0392b;
}

.cancel-btn {
  background: #7f8c8d;
  color: white;
}

.cancel-btn:hover {
  background: #636e72;
}

/* =====================
   DROPDOWNS
===================== */
select {
  padding: 8px 10px;
  margin: 4px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
  background: white;
}

/* =====================
   MODAL
===================== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 10px;
}

.modal-content {
  background: white;
  width: 100%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  border-radius: 12px;
  padding: 15px;
  animation: slideUp 0.25s ease;
}

.modal table {
  min-width: unset;
}

.modal th, .modal td {
  font-size: 13px;
  padding: 8px;
}

/* =====================
   HEADINGS
===================== */
h1, h2, h3 {
  margin: 10px 0;
  text-align: center;
}

/* =====================
   MOBILE OPTIMIZATION
===================== */
@media (max-width: 600px) {

  table {
    min-width: 400px; /* allows horizontal scroll */
  }

  th, td {
    font-size: 12px;
    padding: 8px;
  }

  button {
    font-size: 12px;
    padding: 6px 10px;
  }

  select {
    font-size: 13px;
    width: 48%;
    margin: 4px 1%;
  }

  .modal-content {
    padding: 12px;
  }
}

  .cash-on-hand {
    background-color: #b6b451; /* light gray background */
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); /* subtle shadow */
    max-width: 600px; /* center on large screens */
    margin: 20px auto; /* center horizontally */
    font-family: Arial, sans-serif;
  }

 /* Container for the form */
  .manual-cash-form {
    margin: 10px 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* Each row (IN/OUT) */
  .manual-cash-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
  }

  /* Label styling */
  .manual-cash-row label {
    min-width: 80px;
    font-weight: bold;
  }

  /* Inputs styling with fixed width */
  .manual-cash-row input[type="text"],
  .manual-cash-row input[type="number"] {
    width: 120px;       /* fixed width */
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    box-sizing: border-box;
  }

  /* Button styling */
  #updateCash {
    padding: 8px 15px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 14px;
    cursor: pointer;
    align-self: flex-start;
  }

  #updateCash:hover {
    background-color: #0056b3;
  }

  #updateCash {
    display: block;       /* make it a block element */
    width: auto;          /* keep natural width */
    margin: 0 auto;       /* center horizontally */
    padding: 8px 15px;
    background-color: #283ba7;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 14px;
    cursor: pointer;
  }

  #updateCash:hover {
    background-color: #218838;
  }

  /* Responsive for small screens */
  @media (max-width: 500px) {
    .manual-cash-row {
      flex-direction: column;
      align-items: flex-start;
    }

    /* Keep inputs small on mobile */
    .manual-cash-row input[type="text"],
    .manual-cash-row input[type="number"] {
      width: 120px; /* fixed small width even on mobile */
    }

    input-group {
      flex-direction: row; /* keep details + amount side by side */
      gap: 5px;
    }
 
  }

   @media (max-width: 480px) {
    .manual-cash-row label,
    .manual-cash-row input {
      flex: 1 1 100%;  /* stack vertically */
      min-width: auto;
    }
  }

/* =====================
   ANIMATION
===================== */
@keyframes slideUp {
  from {
    transform: translateY(20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* =====================
   HAMBURGER & MOBILE MENU
===================== */
.hamburger {
  font-size: 24px;
  background: none;
  border: none;
  color: white;
  cursor: pointer;
}

.mobile-menu {
  display: none;
  position: fixed;
  top: 60px;
  right: 15px;
  background: white;
  flex-direction: column;
  border-radius: 8px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.2);
  z-index: 9999;
}

.mobile-menu.show {
  display: flex;
}

.mobile-menu button {
  background-color: #fff;
  color: #06812b;
  border: none;
  padding: 12px;
  border-bottom: 1px solid #ddd;
  cursor: pointer;
  font-size: 14px;
}

.mobile-menu button:last-child {
  border-bottom: none;
}

/* Desktop: horizontal menu */
@media(min-width: 768px){
  .mobile-menu { 
    position: static;  
    display: flex; 
    flex-direction: row; 
    margin-top:0; 
    background: none;
    box-shadow: none;
    width: auto;
  }
  .mobile-menu button { 
    margin: 0 5px; 
    border: none; 
    background: none;
    color: white;
  }
}

  /* Center and bold the current cash display */
  #currentCashContainer {
    text-align: center;
    font-weight: bold;
    font-size: 18px; /* optional: make it slightly bigger */
    margin: 15px 0;
  }

  #cashMovementsTable th,
  #cashMovementsTable td {
    border: 1px solid black; /* black borders */
    padding: 8px;
    text-align: center;
  }

  #cashMovementsTable th {
    background-color: #cfd8e6; /* slightly darker header */
  }

   #currentCashContainer {
    color: #283ba7;
    text-align: center;
    font-weight: bold;
    font-size: 20px;
    text-decoration: underline; /* this adds the underline */
  }

  .table-scroll-3 {
  max-height: 200px;   /* ‚âà 3 rows (adjust if needed) */
  overflow-y: auto;
  border-radius: 8px;
}

/* Keep header visible while scrolling */
.table-scroll-3 thead th {
  position: sticky;
  top: 0;
  background: #c9cfc8;
  z-index: 2;
}

/* Mobile-friendly row height */
#expensesReportSummaryBody tr {
  height: 48px;
}

</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseClient = supabase.createClient(
  "https://ismicrntffubdldeqpkh.supabase.co",
  "sb_publishable_ZAiS4CtJOP6FbV7pmlAGWw__dsvwHqG"
);
</script>
</head>

<body>

<header class="main-header">
  <div class="header-left">
    <h1>BAIG'S POS Dashboard</h1>
    <button class="hamburger" onclick="toggleMenu()">‚ò∞</button>
  </div>
</header>

<!-- Floating dropdown menu -->
<nav id="mobileMenu" class="mobile-menu">
  <button onclick="showSection('receipts')">Receipt History</button>
  <button onclick="showSection('expenses')">Add Expenses, FP & Grab</button>
  <button onclick="showSection('cashonhand')">Cash on Hand</button>
  <button onclick="showSection('reports')">Records</button>

</nav>


<!-- SECTIONS -->
<div id="receipts"><br>
  <h1>Receipts History</h1>
  

  <!-- Payment Summary -->
  <div id="paymentSummary" style="text-align:center; margin-top: 10px; font-weight: bold; font-size: 14px;"></div>

  <!-- Receipts Table -->
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Date</th>
          <th>Total</th>
          <th>Payment</th>
          <th>Service</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>
  </div>

  <!-- MODALS -->
<div id="viewModal">
  <div class="modal-content">
    <div class="modal-header">Receipt Preview</div>
    <div id="receiptPreview"></div>
    <div class="modal-buttons">
      <button class="cancel-btn" onclick="closeViewModal()">Close</button>
    </div>
  </div>
</div>


  <div style="text-align:center; margin-top:15px;">
    <button class="view-btn" style="background: #72003f;" onclick="openReportModal()">‚ûï REPORT</button>
  </div><br><br>

  <div style="text-align:center; margin:15px 0;">
    <button class="back-btn" onclick="goBack()">‚¨Ö Back to POS</button>
  </div>

  <div id="reportModal">
  <div class="modal-content">
    <div class="modal-header">Add to Report</div>
    <p style="text-align:center;">Are you sure you want to add <b>ALL receipts</b> to the report?</p>
    <div class="modal-buttons">
      <button class="confirm-btn" onclick="confirmAddToReport()">Yes</button>
      <button class="cancel-btn" onclick="closeReportModal()">Cancel</button>
    </div>
  </div>
</div>


<!-- Archive Modal -->
<div id="archiveModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">Archive Receipt</div>

    <label style="font-size:13px;">Reason for archiving</label>
    <input
      type="text"
      id="archiveReasonInput"
      placeholder="e.g. Wrong order, refunded, void"
      style="width:100%; padding:8px; margin-top:6px;"
    />

    <div class="modal-buttons">
      <button class="confirm-btn" id="archiveConfirmBtn">Archive</button>
      <button class="cancel-btn" onclick="closeArchiveModal()">Cancel</button>
    </div>
  </div>
</div>



</div>

<!-- CASH ON HAND SECTION -->
<div id="cashonhand" style="display:none; padding:10px;">

  <div class="cash-on-hand">
    <h2 style="text-align:center;">Cash on Hand</h2>

    <div id="currentCashContainer" style="color:#152166; text-align:center; margin-bottom:10px;">
      Current Cash: ‚Ç±<span id="currentCash">0.00</span>
    </div>


    <!-- Cash Movements -->
    <h3 style="text-align:center; margin-top:20px;">Cash Movements</h3>

    <div style="overflow-x:auto;"> <!-- makes table scrollable on small screens -->
      <table id="cashMovementsTable" style="background:#dde6f0; width:100%; min-width:700px; border-collapse:collapse;">
        <thead>
          <tr>
            <th>IN Details</th>
            <th>IN Amount (‚Ç±)</th>
            <th>OUT Details</th>
            <th>OUT Amount (‚Ç±)</th>
            <th>Cashier</th>
            <th>Date</th>
            <th>ID</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="cashSaveStatus" style="margin-top:8px; font-size:14px;"></div>
    <button id="saveCashMovements" style="margin-top:15px; width:50%;">
      Save Cash Movements
    </button>
    <br><br>
    <button id="deleteCashTable" style="margin:10px 0; background:#c0392b; color:#fff;">
      üóë Clear All 
    </button>

    <!-- Manual IN / OUT -->
<div class="manual-cash-form" style="margin-bottom:15px;">

  <!-- Manual IN -->
  <div style="margin-bottom:10px;">
    <div style="font-weight:bold; margin-bottom:5px;">Manual IN:</div>
    <div style="display:flex; flex-wrap:wrap; gap:5px;">
      <input type="text" id="manualInName" placeholder="Details" style="flex:2 1 120px; min-width:100px; padding:6px;">
      <input type="number" id="manualInAmount" placeholder="‚Ç±0.00" style="flex:1 1 80px; min-width:70px; padding:6px;">
      <input type="text" id="manualInCashier" placeholder="Cashier" style="flex:1 1 100px; min-width:80px; padding:6px;">
    </div>
  </div>

  <!-- Manual OUT 
  <div style="margin-bottom:10px;">
    <div style="font-weight:bold; margin-bottom:5px;">Manual OUT:</div>
    <div style="display:flex; flex-wrap:wrap; gap:5px;">
      <input type="text" id="manualOutName" placeholder="Details" style="flex:2 1 120px; min-width:100px; padding:6px;">
      <input type="number" id="manualOutAmount" placeholder="‚Ç±0.00" style="flex:1 1 80px; min-width:70px; padding:6px;">
      <input type="text" id="manualOutCashier" placeholder="Cashier" style="flex:1 1 100px; min-width:80px; padding:6px;">
    </div>
  </div>-->

  <button id="updateCash" style="width:100%; padding:8px; font-size:14px;">
    Add Manual Entry
  </button>
</div>


  </div>
</div>






</div>



<div id="reports" style="display:none; ">
 <div style=" background: #9dfd90;">
  <hr style="margin:30px 0; background: #9dfd90;">
  <h2 style="text-align:center; background: #9dfd90;">üìä Store Sales</h2>

  <!-- Filters -->
  <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px; width:80%; margin-left:auto; margin-right:auto; flex-wrap:wrap; background: #9dfd90;">
  <select id="salesFilterYear" onchange="applySalesFilter()" style="width:45%; padding:6px; font-size:12px;">
    <!-- years options -->
  </select>

  <select id="salesFilterMonth" onchange="applySalesFilter()" style="width:45%; padding:6px; font-size:12px;">
    <option value="">All Months</option>
    <option value="01">Jan</option>
    <option value="02">Feb</option>
    <option value="03">Mar</option>
    <option value="04">Apr</option>
    <option value="05">May</option>
    <option value="06">Jun</option>
    <option value="07">Jul</option>
    <option value="08">Aug</option>
    <option value="09">Sep</option>
    <option value="10">Oct</option>
    <option value="11">Nov</option>
    <option value="12">Dec</option>
  </select>
</div>


  <!-- Summary Table -->
 <div class="table-scroll-3" id="salesReportContainer" style="display:none; background:#93e2a0;">
  <table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr>
        <th>Date</th>
        <th>Total Amount</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="salesReportSummaryBody"></tbody>
  </table>
</div>

</div> 
  <!-- DELIVERY SALES (Foodpanda & Grab) Preview -->
<div id="deliveryReports" style="display:none; margin-top:30px; background: #eb90fd;">
  <hr style="margin:30px 0;">
  <h2 style="text-align:center;">üì¶ Foodpanda & Grab Sales</h2>

  <!-- Filters -->
  <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px; width:80%; margin-left:auto; margin-right:auto; flex-wrap:wrap;">
    <select id="deliveryFilterYear" onchange="applyDeliveryFilter()" style="width:45%; padding:6px; font-size:12px;">
      <!-- Years will load dynamically -->
    </select>

    <select id="deliveryFilterMonth" onchange="applyDeliveryFilter()" style="width:45%; padding:6px; font-size:12px;">
      <option value="">All Months</option>
      <option value="01">Jan</option>
      <option value="02">Feb</option>
      <option value="03">Mar</option>
      <option value="04">Apr</option>
      <option value="05">May</option>
      <option value="06">Jun</option>
      <option value="07">Jul</option>
      <option value="08">Aug</option>
      <option value="09">Sep</option>
      <option value="10">Oct</option>
      <option value="11">Nov</option>
      <option value="12">Dec</option>
    </select>
  </div>

 <!-- Summary Table -->
<div class="table-container table-scroll-3"
     id="deliveryReportContainer"
     style="display:none; background: #db69df;">
  <table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr>
        <th>Date</th>
        <th>Foodpanda Net</th>
        <th>Grab Net</th>
      </tr>
    </thead>
    <tbody id="deliveryReportSummaryBody"></tbody>
  </table>
</div>

  </div>
  <!-- Expenses Report Summary -->
<div class="table-container" id="expensesReportContainer"
     style="max-width:600px; margin:20px auto; display:none; background: #04649c;">
  <h3 style="text-align:center;">üìä Expenses Summary Record</h3>

  <!-- Filters -->
<div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px; width:80%; margin-left:auto; margin-right:auto; flex-wrap:wrap;">
  <select id="filterYear" onchange="applyExpensesFilter()" style="width:45%; padding:6px; font-size:12px;">
    <!-- Years will load here -->
  </select>

  <select id="filterMonth" onchange="applyExpensesFilter()" style="width:45%; padding:6px; font-size:12px;">
    <option value="">All Months</option>
    <option value="01">January</option>
    <option value="02">February</option>
    <option value="03">March</option>
    <option value="04">April</option>
    <option value="05">May</option>
    <option value="06">June</option>
    <option value="07">July</option>
    <option value="08">August</option>
    <option value="09">September</option>
    <option value="10">October</option>
    <option value="11">November</option>
    <option value="12">December</option>
  </select>
</div>





<div class="table-scroll-3">
  <table style="background-color:#c9cfc8; border-radius:8px; width:100%; border-collapse:collapse;">
    <thead>
      <tr>
        <th>Date</th>
        <th>Total Amount</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="expensesReportSummaryBody">
      <!-- Filled dynamically -->
    </tbody>
  </table>
</div>

</div>

<div id="expensesViewModal" style="display:none;" class="modal">
  <div class="modal-content">
    <h3 style="text-align:center;">üí∏ Expenses Details</h3>

    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th>Item</th>
          <th>Price</th>
          <th>Payment</th>
        </tr>
      </thead>
      <tbody id="expensesModalBody"></tbody>
    </table>

    <div style="text-align:center; margin-top:10px;">
      <button class="cancel-btn" onclick="closeExpensesModal()">Close</button>
    </div>
  </div>
</div>

<!-- ARCHIVED RECEIPTS (now inside Reports) -->
  <div id="archivedReceipts" style="margin-top:30px; background: #e2e60b;" >
    <h2 style="text-align:center;">üóÑÔ∏è Archived Receipts</h2>

    <div class="table-container "  style="background: #f2f3a6;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Total</th>
            <th>Payment</th>
            <th>Service</th>
            <th>Reason</th>
          </tr>
        </thead>
        <tbody id="archivedTable"></tbody>
      </table>
    </div>
  </div>

</div>


</div>

<!-- SALES MODAL -->
<div id="salesViewModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3 style="text-align:center;">üßæ Sales Details</h3>

    <table>
      <thead>
        <tr>
          <th>Receipt</th>
          <th>Service</th>
          <th>Subtotal</th>
          <th>Discount</th>
          <th>Total</th>
          <th>Payment</th>
        </tr>
      </thead>
      <tbody id="salesModalBody"></tbody>
    </table>

    <div style="text-align:center; margin-top:10px;">
      <button class="cancel-btn" onclick="closeSalesModal()">Close</button>
    </div>
  </div>

  

</div>
<!-- Add Expenses Section -->
<div id="expenses" style="display:none; margin:20px auto; max-width:700px; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">

  <!-- ===== Sub-section 1: Add Expenses ===== -->
  <div style="background:#118f0d; padding:20px; border-radius:10px; margin-bottom:20px;">
    <h2 style="text-align:center; margin-bottom:20px; color:white;">üí∏ Add Expenses</h2>

    <!-- Input Form -->
    <div style="text-align:center; margin-bottom:20px;">
      <input 
        type="text" 
        id="expenseName" 
        placeholder="Expense Item" 
        style="width: 100%; padding:8px; margin-bottom:8px; border-radius:5px; border:1px solid #ccc;"
      >
      <input 
        type="number" 
        id="expensePrice" 
        placeholder="Price" 
        style="width: 80%; padding:8px; margin-bottom:8px; border-radius:5px; border:1px solid #ccc;"
      >

      <input 
        type="text" 
        id="expenseCashier" 
        placeholder="Cashier" 
        style="width: 60%; padding:8px; margin-left:4%; margin-bottom:8px; border-radius:5px; border:1px solid #ccc;"
      >

      <select 
        id="expensePayment"
        style="width: 80%; padding:8px; margin-bottom:8px; border-radius:5px; border:1px solid #ccc;"
      >
        <option value="">Payment Method</option>
        <option value="Cash">Cash</option>
        <option value="GCash">GCash</option>
        <option value="Bank">Bank</option>
      </select>

      <button class="view-btn" onclick="addExpense()" style="margin-top:8px;">Add Expense</button>
      <button class="view-btn" onclick="goToCashOnHand()" style="background:#b3c704; color:white;">Go to Cash on Hand</button>
    </div>

    <!-- Preview Table -->
    <div class="table-container table-scroll-3" style="max-width:100%; margin:0 auto 20px;">
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th>Item</th>
            <th>Price</th>
            <th>Payment</th>
            <th>Cashier</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="expensesTableBody">
          <!-- Dynamically filled by JS -->
        </tbody>
      </table>
    </div>

    <!-- Add to Report Button -->
    <div style="text-align:center; margin-top:10px;">
      <button class="view-btn" style="background: #72003f; color:white; padding:8px 16px; border:none; border-radius:5px;" onclick="addExpensesToReport()">‚ûï REPORT</button>
    </div>
  </div>

  <!-- ===== Sub-section 2: Online Platform Sales ===== -->
  <div style="background:#eb87f8; padding:20px; border-radius:10px;">
    <h3 style="text-align:center; margin-bottom:15px;">üöÄ Online Platform Sales</h3>

    <div style="display:flex; flex-direction:column; gap:10px; max-width:400px; margin:0 auto;">
      <!-- Foodpanda -->
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <label for="foodpandaSales">Foodpanda Sales:</label>
        <input type="number" id="foodpandaSales" placeholder="‚Ç±0.00" style="width:150px; padding:6px; border-radius:5px; border:1px solid #ccc;">
      </div>

      <!-- Calculated Total -->
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span>Total After Foodpanda 30%:</span>
        <span id="foodpandaTotal">‚Ç±0.00</span>
      </div>

      <!-- Grab -->
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <label for="grabSales">Grab Sales:</label>
        <input type="number" id="grabSales" placeholder="‚Ç±0.00" style="width:150px; padding:6px; border-radius:5px; border:1px solid #ccc;">
      </div>

      <!-- Add to Report Button -->
      <div style="text-align:center; margin-top:10px;">
        <button class="view-btn" style="background: #72003f; color:white; padding:8px 16px; border:none; border-radius:5px;" onclick="addDeliverySales()">‚ûï REPORT</button>
      </div>
    </div>
  </div>

</div>





<script>
document.addEventListener("DOMContentLoaded", () => {

   let receipts = JSON.parse(localStorage.getItem("receipts")) || [];
  let archiveIndex = null;

  const historyTable = document.getElementById("historyTable");
  const archivedTable = document.getElementById("archivedTable");

  /* ============================
     HELPERS
  ============================ */
  function formatPaymentShort(payment) {
    let parts = [];
    if (payment.cash > 0) parts.push("Cash");
    if (payment.gcash > 0) parts.push("GCash");
    if (payment.bank > 0) parts.push("Bank");
    return parts.join(" + ") || "-";
  }

  /* ============================
     ACTIVE RECEIPTS
  ============================ */
  function renderHistory() {
    historyTable.innerHTML = "";

    if (receipts.length === 0) {
      historyTable.innerHTML =
        `<tr><td colspan="6" style="text-align:center;color:#999;">No receipts found</td></tr>`;
      document.getElementById("paymentSummary").textContent = "";
      return;
    }

    let totalCash = 0, totalGCash = 0, totalBank = 0, totalSales = 0;

    receipts.forEach(r => {
      totalCash += Number(r.payment.cash) || 0;
      totalGCash += Number(r.payment.gcash) || 0;
      totalBank += Number(r.payment.bank) || 0;
      totalSales += Number(r.total) || 0;
    });

    document.getElementById("paymentSummary").innerHTML = `
      Total Sales Today: ‚Ç±${totalSales.toFixed(2)}<br><br>
      Cash: ‚Ç±${totalCash.toFixed(2)} |
      GCash: ‚Ç±${totalGCash.toFixed(2)} |
      Bank: ‚Ç±${totalBank.toFixed(2)}
    `;

    receipts.forEach((r, index) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${r.id}</td>
        <td>${r.date}</td>
        <td>‚Ç±${Number(r.total).toFixed(2)}</td>
        <td>${formatPaymentShort(r.payment)}</td>
        <td>${r.service}</td>
        <td>
          <button class="view-btn">View</button>
          <button class="archive-btn">Archive</button>
        </td>
      `;

      historyTable.appendChild(row);

      row.querySelector(".view-btn").onclick = () => viewReceipt(r);
      row.querySelector(".archive-btn").onclick = () => openArchiveModal(index);
    });
  }

  /* ============================
     VIEW MODAL
  ============================ */
  function viewReceipt(r) {
    let html = `
      <strong>ID:</strong> ${r.id}<br>
      <strong>Date:</strong> ${r.date}<br>
      <strong>Service:</strong> ${r.service}<br><br>
      <strong>Cashier:</strong> ${r.cashier || '‚Äî'}<br><br>
      <strong>Payment</strong><br>
      Cash: ‚Ç±${(r.payment.cash || 0).toFixed(2)}<br>
      GCash: ‚Ç±${(r.payment.gcash || 0).toFixed(2)}<br>
      Bank: ‚Ç±${(r.payment.bank || 0).toFixed(2)}<br>
      <hr>
    `;

    r.items.forEach(item => {
      html += `${item.name} x${item.qty || 1} ‚Äî ‚Ç±${(item.price * (item.qty || 1)).toFixed(2)}<br>`;
    });

    html += `
      <hr>
      Subtotal: ‚Ç±${r.subtotal.toFixed(2)}<br>
      Discount: ‚Ç±${r.discount.toFixed(2)}<br>
      <strong>Total: ‚Ç±${r.total.toFixed(2)}</strong>
    `;

    document.getElementById("receiptPreview").innerHTML = html;
    document.getElementById("viewModal").style.display = "flex";
  }

  function closeViewModal() {
    document.getElementById("viewModal").style.display = "none";
  }

  /* ============================
     ARCHIVE MODAL
  ============================ */
  function openArchiveModal(index) {
    archiveIndex = index;
    document.getElementById("archiveReasonInput").value = "";
    document.getElementById("archiveModal").style.display = "flex";
  }

  function closeArchiveModal() {
    archiveIndex = null;
    document.getElementById("archiveModal").style.display = "none";
  }

  /* ============================
     ARCHIVE ‚Üí SUPABASE
  ============================ */
  document.getElementById("archiveConfirmBtn").addEventListener("click", async () => {
    const reason = document.getElementById("archiveReasonInput").value.trim();
    if (!reason) {
      alert("Please enter a reason.");
      return;
    }

    const receipt = receipts.splice(archiveIndex, 1)[0];

    const { error } = await supabaseClient
      .from("archived_receipts")
      .insert([{
        receipt_id: receipt.id,
        date: receipt.date,
        total: receipt.total,
        payment: receipt.payment,
        service: receipt.service,
        items: receipt.items,
        subtotal: receipt.subtotal,
        discount: receipt.discount,
        archive_reason: reason
      }]);

    if (error) {
      alert("Failed to archive receipt");
      console.error(error);
      return;
    }

    localStorage.setItem("receipts", JSON.stringify(receipts));
    renderHistory();
    renderArchived();
    closeArchiveModal();
  });

  /* ============================
     LOAD ARCHIVED FROM SUPABASE
  ============================ */
  async function renderArchived() {
    archivedTable.innerHTML = "";

    const { data, error } = await supabaseClient
      .from("archived_receipts")
      .select("*")
      .order("archived_at", { ascending: false });

    if (error) {
      archivedTable.innerHTML =
        `<tr><td colspan="6" style="color:red;">Failed to load archived receipts</td></tr>`;
      return;
    }

    if (!data || data.length === 0) {
      archivedTable.innerHTML =
        `<tr><td colspan="6" style="text-align:center;color:#999;">No archived receipts</td></tr>`;
      return;
    }

    data.forEach(r => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${r.receipt_id}</td>
        <td>${r.date}</td>
        <td>‚Ç±${Number(r.total).toFixed(2)}</td>
        <td>${formatPaymentShort(r.payment)}</td>
        <td>${r.service}</td>
        <td>${r.archive_reason}</td>
      `;
      archivedTable.appendChild(row);
    });
  }

  /* ============================
     INIT
  ============================ */
  renderHistory();
  renderArchived();

  window.closeViewModal = closeViewModal;
  window.closeArchiveModal = closeArchiveModal;

});
</script>





<script>

  function closeViewModal() { 
  document.getElementById("viewModal").style.display = "none"; 
}

// Back to POS
function goBack() {
  window.location.href = "index.html";
}

function toggleMenu() {
  const menu = document.getElementById("mobileMenu");
  menu.classList.toggle("show");
}


function showSection(sectionId) {
  const sections = ["receipts", "reports", "expenses", "cashonhand"];

  // Hide all sections
  sections.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  });

  // Show selected section
  const selected = document.getElementById(sectionId);
  if (selected) selected.style.display = "block";

  // Close the menu
  const menu = document.getElementById("mobileMenu");
  menu.classList.remove("show"); // <- THIS now works
}





// REPORT LOGIC
function openReportModal(){
  if(receipts.length===0){ alert("No receipts to save."); return; }
  document.getElementById("reportModal").style.display="flex";
}
function closeReportModal(){ document.getElementById("reportModal").style.display="none"; }

async function confirmAddToReport() {
  closeReportModal();

  // Fetch receipts fresh from localStorage and parse
  let receipts = JSON.parse(localStorage.getItem("receipts")) || [];

  // Ensure we have an array
  if (!Array.isArray(receipts) || receipts.length === 0) {
    alert("No receipts to add.");
    return;
  }

  // Build payload
  const payload = receipts.map(r => ({
    receipt_id: r.id,
    receipt_date: r.date,
    service: r.service,
    items: r.items,
    payment: r.payment,
    subtotal: r.subtotal,
    discount: r.discount,
    total: r.total,
    cashier: r.cashier || '‚Äî'
  }));

  // Save to Supabase
  const { error } = await supabaseClient
    .from("sales_reports")
    .upsert(payload, { onConflict: "receipt_id" });

  if (error) {
    console.error(error);
    alert("Error saving report.");
    return;
  }

  // Clear local data & refresh table
  localStorage.removeItem("receipts");
  receipts = [];
  const historyTable = document.getElementById("historyTable");
  historyTable.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#999;">No receipts found</td></tr>`;
  document.getElementById("paymentSummary").textContent = "";

  // Refresh report list if function exists
  if (typeof loadReportDates === "function") {
    await loadReportDates();
  }

  alert("All receipts successfully added to report ‚úÖ");
}

let allSalesData = [];

/* ==============================
   LOAD SALES
================================ */
async function loadSalesReport() {
  const { data, error } = await supabaseClient
    .from("sales_reports")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  if (!data || data.length === 0) {
    document.getElementById("salesReportContainer").style.display = "none";
    return;
  }

  allSalesData = data;

  populateSalesYearFilter(data);
  setSalesDefaultMonth();
  applySalesFilter();

  // Show the report table but keep the section hidden until menu clicked
  document.getElementById("salesReportContainer").style.display = "block";
  // Do NOT auto-show the whole section:
  // document.getElementById("reports").style.display = "block"; <- remove this
}


/* ==============================
   YEAR FILTER
================================ */
function populateSalesYearFilter(data) {
  const yearSelect = document.getElementById("salesFilterYear");
  yearSelect.innerHTML = "";

  const years = [...new Set(
    data.map(s => new Date(s.created_at).getFullYear())
  )].sort((a, b) => b - a);

  years.forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    yearSelect.appendChild(opt);
  });

  yearSelect.value = new Date().getFullYear();
}

/* ==============================
   DEFAULT MONTH
================================ */
function setSalesDefaultMonth() {
  const m = String(new Date().getMonth() + 1).padStart(2, "0");
  document.getElementById("salesFilterMonth").value = m;
}

/* ==============================
   APPLY FILTER
================================ */
function applySalesFilter() {
  const year = document.getElementById("salesFilterYear").value;
  const month = document.getElementById("salesFilterMonth").value;

  let filtered = [...allSalesData];

  if (year) {
    filtered = filtered.filter(s =>
      new Date(s.created_at).getFullYear().toString() === year
    );
  }

  if (month) {
    filtered = filtered.filter(s =>
      String(new Date(s.created_at).getMonth() + 1).padStart(2, "0") === month
    );
  }

  renderSalesSummary(filtered);
}

/* ==============================
   SUMMARY TABLE
================================ */
function renderSalesSummary(data) {
  const tbody = document.getElementById("salesReportSummaryBody");
  tbody.innerHTML = "";

  if (data.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="3" style="text-align:center;color:#888;">
          No sales found
        </td>
      </tr>`;
    return;
  }

  // Group by DATE
  const grouped = {};
  data.forEach(s => {
    const dateKey = s.created_at.split("T")[0];
    if (!grouped[dateKey]) grouped[dateKey] = [];
    grouped[dateKey].push(s);
  });

  Object.keys(grouped)
    .sort((a, b) => new Date(b) - new Date(a))
    .forEach(date => {

      const subtotal = grouped[date].reduce(
  (sum, s) => sum + Number(s.subtotal), 0
);


      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${formatDate(date)}</td>
        <td><strong>‚Ç±${subtotal.toFixed(2)}</strong></td>
        <td>
          <button class="view-btn"
            onclick='openSalesModal(${JSON.stringify(grouped[date])})'>
            View
          </button>
        </td>
      `;
      tbody.appendChild(row);
    });
}

/* ==============================
   MODAL
================================ */
function openSalesModal(sales) {
  const tbody = document.getElementById("salesModalBody");
  tbody.innerHTML = "";

  sales.forEach(s => {
    const payment = [];
    if (s.payment.cash > 0) payment.push("Cash");
    if (s.payment.gcash > 0) payment.push("GCash");
    if (s.payment.bank > 0) payment.push("Bank");

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${s.receipt_id || "-"}</td>
      <td>${s.service || "-"}</td>
      <td>‚Ç±${Number(s.subtotal).toFixed(2)}</td>
      <td>‚Ç±${Number(s.discount).toFixed(2)}</td>
      <td><strong>‚Ç±${Number(s.total).toFixed(2)}</strong></td>
      <td>${payment.length > 0 ? payment.join(", ") : "-"}</td>
    `;
    tbody.appendChild(row);
  });

  document.getElementById("salesViewModal").style.display = "flex";
}

function closeSalesModal() {
  document.getElementById("salesViewModal").style.display = "none";
}

/* ==============================
   DATE FORMAT (SAFE)
================================ */
function formatDate(dateStr) {
  return new Date(dateStr + "T00:00:00")
    .toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric"
    });
}

/* ==============================
   INIT
================================ */
loadSalesReport();

// Local array to hold expenses before sending
let expenses = JSON.parse(localStorage.getItem("localExpenses")) || [];


function renderExpenses() {
  const tbody = document.getElementById("expensesTableBody");
  tbody.innerHTML = "";

  if (expenses.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align:center;color:#999;">
          No expenses added
        </td>
      </tr>`;
    return;
  }

  expenses.forEach((exp, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${exp.item}</td>
      <td>‚Ç±${Number(exp.price).toFixed(2)}</td>
      <td>${exp.payment}</td>
      <td>${exp.cashier}</td> <!-- show cashier -->
      <td>
        <button class="delete-btn" onclick="removeExpense(${index})">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}



// Remove a single expense by index
function removeExpense(index) {
  // Remove from array
  expenses.splice(index, 1);

  // Save back to localStorage
  localStorage.setItem('expenses', JSON.stringify(expenses));

  // Re-render the table
  renderExpenses();
}

// ----------------------------
// Add a new expense locally
// ----------------------------
function addExpense() {
  const nameInput = document.getElementById("expenseName");
  const priceInput = document.getElementById("expensePrice");
  const paymentInput = document.getElementById("expensePayment");
  const cashierInput = document.getElementById("expenseCashier"); // new

  const item = nameInput.value.trim();
  const price = parseFloat(priceInput.value);
  const payment = paymentInput.value;
  const cashier = cashierInput.value.trim() || '‚Äî'; // default if empty

  if (!item || isNaN(price) || !payment) {
    alert("Please fill in item, price, payment method.");
    return;
  }

  expenses.push({ item, price, payment, cashier }); // add cashier

  saveExpensesLocally();
  renderExpenses();

  // Clear inputs
  nameInput.value = "";
  priceInput.value = "";
  paymentInput.value = "";
  cashierInput.value = "";
}



function saveExpensesLocally() {
  localStorage.setItem("localExpenses", JSON.stringify(expenses));
}
async function addExpensesToReport() {
  if (expenses.length === 0) {
    alert("No expenses to add.");
    return;
  }

  const payload = expenses.map(exp => ({
    item: exp.item,
    price: exp.price,
    payment: { cash: exp.payment.toLowerCase() === "cash" ? exp.price : 0 },
    cashier: exp.cashier // added
  }));

  const { error } = await supabaseClient
    .from("expenses_reports")
    .insert(payload);

  if (error) {
    console.error(error);
    alert("Error saving expenses.");
    return;
  }

  expenses = [];
  localStorage.removeItem("localExpenses");

  renderExpenses();
  alert("Expenses added successfully ‚úÖ");
}

// ==============================
// LOAD EXPENSES REPORT
// ==============================
let allExpensesData = [];

async function loadExpensesReport() {
  const { data, error } = await supabaseClient
    .from("expenses_reports")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Supabase error:", error);
    return;
  }

  if (!data || data.length === 0) {
    document.getElementById("expensesReportContainer").style.display = "none";
    return;
  }

  allExpensesData = data;

  populateYearFilter(data);
  setDefaultMonth();
  applyExpensesFilter();

  document.getElementById("expensesReportContainer").style.display = "block";
}

/* ==============================
   YEAR DROPDOWN
================================ */
function populateYearFilter(data) {
  const yearSelect = document.getElementById("filterYear");
  yearSelect.innerHTML = "";

  const years = [...new Set(
    data.map(e => new Date(e.created_at).getFullYear())
  )].sort((a, b) => b - a);

  years.forEach(year => {
    const opt = document.createElement("option");
    opt.value = year;
    opt.textContent = year;
    yearSelect.appendChild(opt);
  });

  yearSelect.value = new Date().getFullYear();
}

/* ==============================
   DEFAULT MONTH = CURRENT
================================ */
function setDefaultMonth() {
  const month = String(new Date().getMonth() + 1).padStart(2, "0");
  document.getElementById("filterMonth").value = month;
}

/* ==============================
   APPLY FILTERS
================================ */
function applyExpensesFilter() {
  const year = document.getElementById("filterYear").value;
  const month = document.getElementById("filterMonth").value;

  let filtered = [...allExpensesData];

  if (year) {
    filtered = filtered.filter(e =>
      new Date(e.created_at).getFullYear().toString() === year
    );
  }

  if (month) {
    filtered = filtered.filter(e =>
      String(new Date(e.created_at).getMonth() + 1).padStart(2, "0") === month
    );
  }

  renderExpensesSummary(filtered);
}

/* ==============================
   SUMMARY TABLE
================================ */
function renderExpensesSummary(data) {
  const tbody = document.getElementById("expensesReportSummaryBody");
  tbody.innerHTML = "";

  if (data.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="3" style="text-align:center;color:#888;">
          No expenses found
        </td>
      </tr>`;
    return;
  }

  // Group by DATE (YYYY-MM-DD)
  const grouped = {};
  data.forEach(e => {
    const dateKey = e.created_at.split("T")[0];
    if (!grouped[dateKey]) grouped[dateKey] = [];
    grouped[dateKey].push(e);
  });

  Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a))
    .forEach(date => {

      const total = grouped[date].reduce(
        (sum, e) => sum + Number(e.price), 0
      );

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${formatDate(date)}</td>
        <td><strong>‚Ç±${total.toFixed(2)}</strong></td>
        <td>
          <button class="view-btn"
            onclick='openExpensesModal(${JSON.stringify(grouped[date])})'>
            View
          </button>
        </td>
      `;
      tbody.appendChild(row);
    });
}

/* ==============================
   MODAL VIEW
================================ */
function openExpensesModal(expenses) {
  const tbody = document.getElementById("expensesModalBody");
  tbody.innerHTML = "";

  expenses.forEach(e => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${e.item}</td>
      <td>‚Ç±${Number(e.price).toFixed(2)}</td>
      <td>${e.payment}</td>
    `;
    tbody.appendChild(row);
  });

  document.getElementById("expensesViewModal").style.display = "flex";
}

function closeExpensesModal() {
  document.getElementById("expensesViewModal").style.display = "none";
}

/* ==============================
   DATE FORMAT FIX (NO INVALID)
================================ */
function formatDate(dateStr) {
  const d = new Date(dateStr + "T00:00:00");
  return d.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric"
  });
}

/* ==============================
   INIT
================================ */
loadExpensesReport();


// Update Foodpanda total after 30% commission
document.getElementById("foodpandaSales").addEventListener("input", () => {
  const value = parseFloat(document.getElementById("foodpandaSales").value) || 0;
  const total = value * 0.7; // minus 30%
  document.getElementById("foodpandaTotal").innerText = `‚Ç±${total.toFixed(2)}`;
});

// Function to add delivery sales to Supabase
async function addDeliverySales() {
  const foodpanda = parseFloat(document.getElementById("foodpandaSales").value) || 0;
  const grab = parseFloat(document.getElementById("grabSales").value) || 0;

  if(foodpanda <= 0 && grab <= 0) {
    alert("Please enter at least one value for Foodpanda or Grab.");
    return;
  }

  const payload = [];

  // Foodpanda entry (30% deduction)
  if(foodpanda > 0){
    payload.push({
      platform: "Foodpanda",
      gross_amount: foodpanda,
      net_amount: foodpanda * 0.7, // minus 30%
      date: new Date() // optional: you can use specific date input
    });
  }

  // Grab entry (full amount)
  if(grab > 0){
    payload.push({
      platform: "Grab",
      gross_amount: grab,
      net_amount: grab,
      date: new Date()
    });
  }

  try {
    const { data, error } = await supabaseClient
      .from("delivery_sales")
      .insert(payload);

    if(error){
      console.error(error);
      alert("Error saving delivery sales.");
      return;
    }

    alert("Delivery sales added ‚úÖ");

    // Clear inputs
    document.getElementById("foodpandaSales").value = "";
    document.getElementById("grabSales").value = "";
    document.getElementById("foodpandaTotal").innerText = "‚Ç±0.00";

  

  } catch(err){
    console.error(err);
    alert("Unexpected error occurred.");
  }
}

let allDeliveryData = [];

// Load delivery sales from Supabase
async function loadDeliveryReport() {
  const { data, error } = await supabaseClient
    .from("delivery_sales")
    .select("*")
    .order("date", { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  allDeliveryData = data || [];

  populateDeliveryYearFilter(allDeliveryData);
  setDeliveryDefaultMonth();
  applyDeliveryFilter();

  document.getElementById("deliveryReportContainer").style.display = "block";
  document.getElementById("deliveryReports").style.display = "block";
}

// Populate year filter dynamically
function populateDeliveryYearFilter(data) {
  const years = [...new Set(data.map(d => new Date(d.date).getFullYear()))].sort((a,b)=>b-a);
  const yearSelect = document.getElementById("deliveryFilterYear");
  yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join("");
}

// Set default month to all
function setDeliveryDefaultMonth() {
  document.getElementById("deliveryFilterMonth").value = "";
}

// Apply filter and show summary table
function applyDeliveryFilter() {
  const year = document.getElementById("deliveryFilterYear").value;
  const month = document.getElementById("deliveryFilterMonth").value;

  const filtered = allDeliveryData.filter(d => {
    const date = new Date(d.date);
    return (!year || date.getFullYear() == year) &&
           (!month || (date.getMonth()+1).toString().padStart(2,"0") === month);
  });

  const summaryBody = document.getElementById("deliveryReportSummaryBody");
  summaryBody.innerHTML = "";

  if(filtered.length === 0) {
    summaryBody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#999;">No delivery sales found</td></tr>`;
    return;
  }

  // Group by date
  const grouped = {};
  filtered.forEach(d => {
    const dateStr = new Date(d.date).toLocaleDateString("en-US", { year:"numeric", month:"long", day:"numeric" });
    if(!grouped[dateStr]) grouped[dateStr] = { foodpanda: 0, grab: 0 };
    if(d.platform.toLowerCase() === "foodpanda") grouped[dateStr].foodpanda += Number(d.net_amount);
    if(d.platform.toLowerCase() === "grab") grouped[dateStr].grab += Number(d.net_amount);
  });

  Object.keys(grouped).forEach(dateStr => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${dateStr}</td>
      <td>‚Ç±${grouped[dateStr].foodpanda.toFixed(2)}</td>
      <td>‚Ç±${grouped[dateStr].grab.toFixed(2)}</td>
    `;
    summaryBody.appendChild(row);
  });
}




// Call after page loads
loadDeliveryReport();


//CashonHand
//CashonHand
const cashTableBody = document.querySelector('#cashMovementsTable tbody');
const currentCashSpan = document.getElementById('currentCash');

const manualInNameInput = document.getElementById('manualInName');
const manualInAmountInput = document.getElementById('manualInAmount');
const manualInCashierInput = document.getElementById('manualInCashier'); // <-- added
const manualOutNameInput = document.getElementById('manualOutName');
const manualOutAmountInput = document.getElementById('manualOutAmount');
const manualOutCashierInput = document.getElementById('manualOutCashier'); // <-- added
const updateCashBtn = document.getElementById('updateCash');

// Load manual entries from localStorage or initialize
let manualEntries = JSON.parse(localStorage.getItem('manualEntries')) || [];


// Helper: create unique ID
function generateUniqueId() {
  return Date.now() + Math.floor(Math.random() * 1000);
}

// ============================
// Manual IN/OUT Button
// ============================
updateCashBtn.addEventListener('click', () => {
  const today = new Date().toISOString().split('T')[0];

  // Manual IN
  const inName = manualInNameInput.value.trim();
  const inAmount = parseFloat(manualInAmountInput.value) || 0;
  const inCashier = manualInCashierInput.value.trim() || '‚Äî';
  if (inName && inAmount > 0) {
    const inId = 1000 + manualEntries.filter(e => e.type === 'in').length;
    manualEntries.push({
    
      type: 'in',
      details: inName,
      amount: inAmount,
      cashier: inCashier,
      date: today,
      id: inId,
    });
    manualInNameInput.value = '';
    manualInAmountInput.value = '';
    manualInCashierInput.value = '';
  }

  // Manual OUT
  const outName = manualOutNameInput.value.trim();
  const outAmount = parseFloat(manualOutAmountInput.value) || 0;
  const outCashier = manualOutCashierInput.value.trim() || '‚Äî';
  if (outName && outAmount > 0) {
    const outId = 2000 + manualEntries.filter(e => e.type === 'out').length;
    manualEntries.push({
      
      type: 'out',
      details: outName,
      amount: outAmount,
      cashier: outCashier,
      date: today,
      id: outId,
    });
    manualOutNameInput.value = '';
    manualOutAmountInput.value = '';
    manualOutCashierInput.value = '';
  }

  localStorage.setItem('manualEntries', JSON.stringify(manualEntries));
  renderCashOnHand();
});
// ----------------------------
// Fetch Cash Sales & Expenses
// ----------------------------
async function fetchCashSales() {
  const receipts = JSON.parse(localStorage.getItem("receipts")) || [];
  return receipts
    .filter(r => r.payment && Number(r.payment.cash) > 0)
    .map((r, index) => ({
      details: 'Store Sales',
      cash: Number(r.subtotal || r.payment.cash || 0),
      cashier: r.cashier || '‚Äî',
      date: r.date || new Date().toISOString().split('T')[0],
      id: 1_000_000 + index, // numeric stable ID
    }));
}

async function fetchCashExpenses() {
  const today = new Date().toISOString().split('T')[0];
  return expenses
    .filter(e => e.payment.toLowerCase() === 'cash')
    .map((e, index) => ({

      details: e.item,
      cash: Number(e.price) || 0,
      cashier: e.cashier || '‚Äî',
      date: today,
      id: 2_000_000 + index, // numeric stable ID
    }))
    .filter(e => e.cash > 0);
}

// ============================
// Render Cash Movements Table
// ============================
async function renderCashOnHand() {
  const sales = await fetchCashSales();      // your sales fetch function
  const expenses = await fetchCashExpenses(); // your expenses fetch function

  let movements = [];

  // Add sales
  sales.forEach(s => movements.push({
    inDetails: s.details,
    inAmount: s.cash,
    outDetails: '',
    outAmount: 0,
    cashier: s.cashier || '‚Äî',
     date: s.date, 
      id: s.id
  }));

  // Add expenses
  expenses.forEach(e => movements.push({
    inDetails: '',
    inAmount: 0,
    outDetails: e.details,
    outAmount: e.cash,
    cashier: e.cashier || '‚Äî',
     date: e.date,
    id: e.id
  }));

  // Add manual entries
  manualEntries.forEach(m => {
    if (m.type === 'in') movements.push({
      inDetails: m.details,
      inAmount: m.amount,
      outDetails: '',
      outAmount: 0,
      cashier: m.cashier,
      date: m.date,
      id: m.id
    });
    if (m.type === 'out') movements.push({
      
      inDetails: '',
      inAmount: 0,
      outDetails: m.details,
      outAmount: m.amount,
      cashier: m.cashier,
       date: m.date,
       id: m.id
    });
  });

  movements.sort((a, b) => new Date(a.date) - new Date(b.date));

  cashTableBody.innerHTML = '';
  let currentCash = 0;

  movements.forEach(m => {
    currentCash += m.inAmount - m.outAmount;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${m.inDetails}</td>
      <td>‚Ç±${m.inAmount.toFixed(2)}</td>
      <td>${m.outDetails}</td>
      <td>‚Ç±${m.outAmount.toFixed(2)}</td>
      <td>${m.cashier || '‚Äî'}</td>
      <td>${m.date}</td>
      <td>${m.id}</td>
    `;
    cashTableBody.appendChild(row);
  });

  currentCashSpan.textContent = currentCash.toFixed(2);
}
// ============================
// Save to Supabase using ID to prevent duplicates
// ============================
async function getAllCashMovements() {
  const sales = await fetchCashSales();
  const expenses = await fetchCashExpenses();

  let movements = [];

  sales.forEach(s => movements.push({

    inDetails: s.details,
    inAmount: Number(s.cash) || 0,
    outDetails: '',
    outAmount: 0,
    cashier: s.cashier || '‚Äî',
    date: s.date,
    id: s.id
  }));

  expenses.forEach(e => movements.push({
    
    inDetails: '',
    inAmount: 0,
    outDetails: e.details,
    outAmount: Number(e.cash) || 0,
    cashier: e.cashier || '‚Äî',
    date: e.date,
    id: e.id
  }));

  manualEntries.forEach(m => movements.push({
    inDetails: m.type === 'in' ? m.details : '',
    inAmount: m.type === 'in' ? Number(m.amount) : 0,
    outDetails: m.type === 'out' ? m.details : '',
    outAmount: m.type === 'out' ? Number(m.amount) : 0,
    cashier: m.cashier || '‚Äî',
    date: m.date,
    id: m.id
  }));

  return movements;
}

async function saveCashMovementsToSupabase() {
  const status = document.getElementById('cashSaveStatus');
  if (status) status.textContent = 'Saving...';

  const movements = await getAllCashMovements();
  if (!movements.length) {
    if (status) status.textContent = 'No data to save';
    return;
  }

  const payload = movements.map(m => ({
               // use unique id
    in_details: m.inDetails || null,
    in_amount: Number(m.inAmount) || 0,
    out_details: m.outDetails || null,
    out_amount: Number(m.outAmount) || 0,
     cashier: m.cashier || '‚Äî',
      date: m.date,
      id: m.id
  }));

  const { error } = await supabaseClient
    .from('cash_movements')
    .upsert(payload, { onConflict: 'id' }); // use id to prevent duplicates

  if (error) {
    console.error('Supabase save error:', error);
    if (status) status.textContent = '‚ùå Save failed';
  } else {
    if (status) status.textContent = '‚úÖ Cash movements saved';
  }
}

// ============================
// Auto-save every 1 min + Save button
// ============================
document.getElementById('saveCashMovements')?.addEventListener('click', saveCashMovementsToSupabase);
setInterval(() => {
  saveCashMovementsToSupabase();
}, 1 * 60 * 1000);

// Initial render
renderCashOnHand();


document
  .getElementById('deleteCashTable')
  ?.addEventListener('click', async () => {

    const ok = confirm(
      'This will permanently DELETE ALL cash movements\n(local + Supabase).\n\nContinue?'
    );
    if (!ok) return;

    // 1Ô∏è‚É£ Clear local manual entries
    manualEntries = [];
    localStorage.removeItem('manualEntries');

    // 2Ô∏è‚É£ Clear table UI completely
    cashTableBody.innerHTML = '';
    currentCashSpan.textContent = '0.00';

    // Optional: clear sales/expenses preview if you want
    // localStorage.removeItem('receipts');
    // localStorage.removeItem('expenses');

    // 3Ô∏è‚É£ Delete ALL rows from Supabase
    const { error } = await supabaseClient
      .from('cash_movements')
      .delete()
      .neq('id', 0); // Delete all rows

    if (error) {
      console.error('Supabase delete error:', error);
      alert('‚ùå Failed to delete data from Supabase');
    } else {
      alert('‚úÖ All cash movements deleted');
    }
  });




// ==============================
// AUTO-REFRESH EXPENSES & CASH
// ==============================
async function autoRefreshAll() {
  await loadExpensesReport();  // refresh expenses
  await renderCashOnHand();  
  await loadSalesReport(); 
  await loadDeliveryReport(); // refresh cash on hand table
}

// refresh every 5 seconds
setInterval(autoRefreshAll, 5000);

// INITIAL LOAD
autoRefreshAll();



function goToCashOnHand() {
  // Hide current section if needed
  document.getElementById('expenses').scrollIntoView({ behavior: 'smooth' });

  // Show cash on hand section
  const cashSection = document.getElementById('cashonhand');
  if(cashSection) cashSection.style.display = 'block';
}


</script>

</body>
</html>
